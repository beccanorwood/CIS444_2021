<!DOCTYPE html>
<html>
    <head>
	     <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
	     <link rel = "stylesheet" href = "/static/bookstore_style.css"/>
    </head>
    <body>
	 <script>

	    	var user_jwt; /* user token */	

		/*==================================================*/
		/*Methods that are strictly for server call/response*/
		/*=================================================*/

		function checkCreds(){

			name = $('#username').val();
			pwd = $('#password').val();

			$.post('/signup', 
			{  
			  username: name,
			  password: pwd
			},
			function(data, status){
			  /*alert("Data: " + data + "\nStatus:" + status);*/
			  /*var value = data['validJWT']*/
			  /*var json = JSON.parse(data);*/
			  		

			  	var isValidToken = data.validJWT;
				console.log("IsValidToken: " + isValidToken);

				if (isValidToken) {
				  user_jwt = data.message;
				  debug_jwt = JSON.stringify(data['message']);
				  alert("User JWT: " + debug_jwt);
				  getValidToken();
				}
				else{
				  alert(JSON.stringify(data['message']) + "this is a failed result");
				}
			
			});	
				
		};

		function validateCreds() {
			
			name = $('#username').val();
			pwd = $('#password').val();

			$.post('/login',
			{
			  username: name,
			  password: pwd
			},
			function(data, status) {
			 	
				var userisValid = data.validCreds;
				console.log("User is Valid: " + userisValid);

				if(userisValid) {
				  user_jwt = data.message;
				  $('#userInfo').hide();
				  getValidToken();
				}
				else {
				  response = data.message
					switch (response) {
					
					case "Error! Account not found":
						alert(JSON.stringify(response));
					case "Incorrect Password. Please try again":
						alert(JSON.stringify(response));
					}
				}
			});

		};

		
		function getValidToken() {
			$.get('/validToken', {
			
				"jwt" : user_jwt
			},
			function(data, status) {
		  	  
				var tokenisValid = data.validToken  
		  	  	console.log("Token is Valid: " + tokenisValid);

			  	if (tokenisValid) {
			  		alert("GET method worked! Token is Valid :)");
					populateBooks();
				}
				else {
			  		alert("GET method worked! Token is not valid though :(");
				}
		  	});
		};

		/*Sends a HTTP GET request with user's jwt and returns valid token*/

		/*Receives a JSON object containing all the books available to purchase*/
		
		function populateBooks(){
			$.getJSON("/populateBookList", function(data) {
		 	
				alert("Populate Books Method reached");
				bookList = data.Books
				console.log(bookList);

				for (let i = 0; i < bookList.length; i++) {
					name = bookList[i]['name'];
					price = bookList[i]['price'];
					console.log("Book Name: " + name);
					console.log("Book Price: " + price);
					$('#booklist').append(`<option value="${name}">${name}</option>`);
					$('#books').show();
					$('#signup').hide();

				}

			});

		};
 		

		/*==========================================================*/ 
		/*Methods that are stricly used to manipulating DOM objects*/
		/*==========================================================*/ 

		$(document).ready(function () {

			$('.signupbtn').on('click', function(){
				$('#userInfo').show();
				$('#welcome').hide();
			});


			$('.loginbtn').on('click', function(){
				$('#welcome').hide();
				$('#userInfo').show();
				$(':submit').attr('onclick', 'validateCreds()');
				$(':submit').attr('value', 'Login');
			});

		});

			/*
			$('#booklist').change(function() {
			  var selectedBook = $(this).val();

			  switch (selectedBook){

			  case "Harry Potter and the Sorcerer's Stone":
				$('#selectedBook').css('background-image', "url('{{media}}/HP1.jpg')");
			 	break;
			  case "Harry Potter and the Chamber of Secrets":
				$('#selectedBook').css('background-image', "url('{{media}}/HP2.jpg')"); 
				break;
			  case "Harry Potter and the Prisoner of Azkaban":                                                                                                                     $('#selectedBook').css('background-image', "url('{{media}}/HP3.jpg')");                                                                                        break;
			  case "Harry Potter and the Goblet of Fire":                                                                                                                          $('#selectedBook').css('background-image', "url('{{media}}/HP4.jpg')");                                                                                        break;
			  case "Harry Potter and the Order of the Pheonix":                                                                                                                    $('#selectedBook').css('background-image', "url('{{media}}/HP5.jpg)')");
				break;
			  case "Harry Potter and the Half-Blook Prince":                                                                                                                       $('#selectedBook').css('background-image', "url('{{media}}/HP6.jpg)')");
				break;
			}
		  });*/

		

	</script>
	<div id = "welcome">
		<h1>Welcome to Neitherstone Norwood Books!</h1>
		<button class = "button signupbtn">Sign Up!</button>
		<button class = "button loginbtn">Login!</button>
	</div>
	<div id = "userInfo">
  		<label for="username">Username:</label><br>
  			<input type="text" id="username" name="username"><br>
  		<label for="password">Password:</label><br>
  			<input type="password" id="password" name="password"><br><br>
  		<input type="submit" value="Signup" onclick = "checkCreds();" >
	</div>
	<div id = "homepage">
		<h1 id = "home_greeting"></h1>
		<button class = "button viewBooks">View Books</button>
	</div>
	
	<div id="books" style="display:none">
		<h1>Buy me</h1>
		<select name="books" id="booklist"></select>
	</div>
	<div id = "selectedBook"></div>
    </body>
</html>
